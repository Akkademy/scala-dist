<?xml version="1.0" encoding="UTF-8"?>

<project name="sbaz" default="build">
  <!-- set the following to your local sbaz-managed directory -->
  <property name="scala.home" value="/home/lex/scala/sbaz/sbaz"/>

  <property name="sbaz.version" value="1.11"/>

  <taskdef
      resource="scala/tools/ant/antlib.xml">
    <classpath>
      <pathelement location="${scala.home}/lib/scala2-compiler.jar"/>
      <pathelement location="${scala.home}/lib/scala2-library.jar"/>
      <pathelement location="${scala.home}/lib/fjbg-tmp.jar"/>
      <pathelement location="${scala.home}/lib/msil-tmp.jar"/>
    </classpath>
  </taskdef>


  <!-- XXX this explicit taskdef can be removed once scala2-library
       is updated in the bazaar... -->
  <taskdef name="sbaz"
             classname="scala.tools.ant.ScalaBazaar">
      <classpath>
            <pathelement location="${scala.home}/lib/scala2-compiler.jar"/>
            <pathelement location="${scala.home}/lib/scala2-library.jar"/>
            <pathelement location="${scala.home}/lib/fjbg-tmp.jar"/>
            <pathelement location="${scala.home}/lib/msil-tmp.jar"/>
       </classpath>
  </taskdef>




  <target name="build.main">
    <mkdir dir="build"/>
    <mkdir dir="build/build.main"/>
    <scalac srcdir="src"
            destdir="build/build.main">
      <classpath>
           <!-- I have to add scala2-library manually??  XXX -->
            <pathelement location="${scala.home}/lib/scala2-library.jar"/>
        <pathelement location="${scala.home}/lib/servlet-api.jar"/>
      </classpath>
      <include name="**/*.scala"/>
    </scalac>

    <jar destfile="build/sbaz.jar"
         basedir="build/build.main">
      <manifest>
        <attribute name="Main-Class" value="sbaz.clui.CommandLine"/>
      </manifest>
    </jar>
  </target>

  <target name="build.tests" depends="build.main">
    <mkdir dir="build/build.tests"/>
    <scalac srcdir="tests"
            destdir="build/build.tests">
      <classpath>
         <pathelement location="${scala.home}/lib/scala2-library.jar"/>
        <!-- how can the following be done in the bazaar?  I'd like sbazlib=junit.jar -->
        <pathelement location="${scala.home}/lib/junit.jar"/>
        <pathelement location="${scala.home}/lib/servlet-api.jar"/>
        <pathelement location="build/sbaz.jar"/>
      </classpath>
      <include name="**/*.scala"/>
    </scalac>

    <jar destfile="build/tests.jar"
         basedir="build/build.tests"/>
  </target>


  <target name="toolScripts">
    <mkdir dir="build/toolScripts"/>
    <scalascript file="build/toolScripts/sbaz"
                 name="Scala Bazaars command-line client"
                 class="sbaz.clui.CommandLine"
                 version="${sbaz.version}"  
		 classpath="#SCALA_HOME#/lib/sbaz.jar:#SCALA_HOME#/misc/sbaz/scala2-library.jar"
                 javaFlags="-Xmx256M -Xms16M"/>   <!-- XXX should be the default, no? -->
  </target>


  <target name="manual.pdf"
          depends="manual.pdf.check"
          unless="manual.pdf.uptodate">
    <mkdir dir="build/manual"/>
    <exec command="docbook2pdf -u --output build/manual doc/manual/manual.xml"/>
  </target>

  <target name="manual.pdf.check">
    <uptodate
          srcfile="doc/manual/manual.xml"
          targetfile="build/manual/manual.pdf"
          property="manual.pdf.uptodate"/>
  </target>



  <target name="manual.html"
          depends="manual.html.check"
          unless="manual.html.uptodate">
    <mkdir dir="build/manual"/>
    <exec command="docbook2html -u --output build/manual doc/manual/manual.xml"/>
  </target>

  <target name="manual.html.check">
    <uptodate
          srcfile="doc/manual/manual.xml"
          targetfile="build/manual/manual.html"
          property="manual.html.uptodate"/>
  </target>

  <target name="manual" depends="manual.html, manual.pdf"/>


  <target name="sbp"  depends="build.main, toolScripts, manual">
    <sbaz file="build/sbaz-${sbaz.version}.sbp"
          adfile="build/sbaz-${sbaz.version}.advert"
          name="sbaz"
          version="${sbaz.version}"
          desc="The command-line interface to Scala Bazaars.  Scala Bazaars
let you share Scala packages and other goodies with other
Scala users.">

      <libset dir="build" includes="sbaz.jar"/>
      <binset dir="build/toolScripts"/>
      <docset dir="build/manual"/>

      <!-- include the version of scala2-library used during compilation -->
      <miscset dir="${scala.home}/lib" includes="scala2-library.jar"/>
    </sbaz>
  </target>


  <target name="clean">
    <delete dir="build"
            includeemptydirs="yes"
            quiet="yes"
            failonerror="no"/>
  </target>

  <target name="build"
          depends="build.main, build.tests"/>

</project>
